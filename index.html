<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¥å…»è¿½è¸ªå™¨</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .tag-item {
            background-color: #e0e0e0;
            padding: 8px 15px;
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .tag-item:hover {
            background-color: #d0d0d0;
        }
        .tag-item.hidden {
            background-color: #f0f0f0;
            color: #999;
            text-decoration: line-through;
        }
        .tag-delete {
            margin-left: 8px;
            color: #f44336;
            cursor: pointer;
        }
        .tag-visibility {
            margin-left: 8px;
            color: #2196F3;
            cursor: pointer;
        }
        .edit-btn {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }
        .edit-btn:hover {
            background-color: #0b7dda;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 500px;
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .remaining-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        .remaining-item {
            flex: 1;
            min-width: 150px;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            color: white;
        }
        .calories {
            background-color: #FF5722;
        }
        .protein {
            background-color: #4CAF50;
        }
        .fat {
            background-color: #FFC107;
        }
        .carbs {
            background-color: #2196F3;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="number"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #388E3C;
        }
        .tabs {
            display: flex;
            margin-bottom: 15px;
        }
        .tab {
            padding: 10px 20px;
            background-color: #eee;
            cursor: pointer;
            border-radius: 4px 4px 0 0;
            margin-right: 5px;
        }
        .tab.active {
            background-color: white;
            border-bottom: 2px solid #4CAF50;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <h1>è¥å…»è¿½è¸ªå™¨</h1>
    
    <div class="card">
        <h2>å‰©ä½™ç›®æ ‡</h2>
        <div class="remaining-container">
            <div class="remaining-item calories">
                <h3>å¡è·¯é‡Œ</h3>
                <p id="remaining-calories">0</p>
            </div>
            <div class="remaining-item protein">
                <h3>è›‹ç™½è´¨ (g)</h3>
                <p id="remaining-protein">0</p>
            </div>
            <div class="remaining-item fat">
                <h3>è„‚è‚ª (g)</h3>
                <p id="remaining-fat">0</p>
            </div>
            <div class="remaining-item carbs">
                <h3>ç¢³æ°´ (g)</h3>
                <p id="remaining-carbs">0</p>
            </div>
        </div>
    </div>

    <div class="tabs">
        <div class="tab active" data-tab="add-food">æ·»åŠ é£Ÿç‰©</div>
        <div class="tab" data-tab="set-goals">è®¾ç½®ç›®æ ‡</div>
        <div class="tab" data-tab="tags">æ ‡ç­¾ç®¡ç†</div>
        <div class="tab" data-tab="history">å†å²è®°å½•</div>
    </div>

    <div class="card tab-content active" id="add-food">
        <h2>æ·»åŠ é£Ÿç‰©</h2>
        <div id="tags-quick-add" style="margin-bottom: 20px;">
            <h3>å¿«é€Ÿæ·»åŠ </h3>
            <div id="quick-tags-container" style="display: flex; flex-wrap: wrap; gap: 10px;"></div>
        </div>
        <form id="add-food-form">
            <div class="form-group">
                <label for="food-calories">å¡è·¯é‡Œ</label>
                <input type="number" id="food-calories" min="0" step="1" required>
            </div>
            <div class="form-group">
                <label for="food-protein">è›‹ç™½è´¨ (g)</label>
                <input type="number" id="food-protein" min="0" step="0.1" required>
            </div>
            <div class="form-group">
                <label for="food-fat">è„‚è‚ª (g)</label>
                <input type="number" id="food-fat" min="0" step="0.1" required>
            </div>
            <div class="form-group">
                <label for="food-carbs">ç¢³æ°´ (g)</label>
                <input type="number" id="food-carbs" min="0" step="0.1" required>
            </div>
            <button type="submit">æ·»åŠ </button>
        </form>
    </div>

    <div class="card tab-content" id="set-goals">
        <h2>è®¾ç½®ç›®æ ‡</h2>
        <form id="set-goals-form">
            <div class="form-group">
                <label for="goal-calories">å¡è·¯é‡Œç›®æ ‡</label>
                <input type="number" id="goal-calories" min="0" step="1" required>
            </div>
            <div class="form-group">
                <label for="goal-protein">è›‹ç™½è´¨ç›®æ ‡ (g)</label>
                <input type="number" id="goal-protein" min="0" step="0.1" required>
            </div>
            <div class="form-group">
                <label for="goal-fat">è„‚è‚ªç›®æ ‡ (g)</label>
                <input type="number" id="goal-fat" min="0" step="0.1" required>
            </div>
            <div class="form-group">
                <label for="goal-carbs">ç¢³æ°´ç›®æ ‡ (g)</label>
                <input type="number" id="goal-carbs" min="0" step="0.1" required>
            </div>
            <button type="submit">ä¿å­˜ç›®æ ‡</button>
        </form>
    </div>

    <div class="card tab-content" id="tags">
        <h2>æ ‡ç­¾ç®¡ç†</h2>
        <form id="tag-form">
            <div class="form-group">
                <label for="tag-name">æ ‡ç­¾åç§°</label>
                <input type="text" id="tag-name" required>
            </div>
            <div class="form-group">
                <label for="tag-calories">å¡è·¯é‡Œ</label>
                <input type="number" id="tag-calories" min="0" step="1" required>
            </div>
            <div class="form-group">
                <label for="tag-protein">è›‹ç™½è´¨ (g)</label>
                <input type="number" id="tag-protein" min="0" step="0.1" required>
            </div>
            <div class="form-group">
                <label for="tag-fat">è„‚è‚ª (g)</label>
                <input type="number" id="tag-fat" min="0" step="0.1" required>
            </div>
            <div class="form-group">
                <label for="tag-carbs">ç¢³æ°´ (g)</label>
                <input type="number" id="tag-carbs" min="0" step="0.1" required>
            </div>
            <button type="submit">ä¿å­˜æ ‡ç­¾</button>
        </form>
        <div style="margin-top: 20px;">
            <h3>å·²ä¿å­˜çš„æ ‡ç­¾</h3>
            <div id="tags-container" style="display: flex; flex-wrap: wrap; gap: 10px;"></div>
        </div>
    </div>

    <div class="card tab-content" id="history">
        <h2>å†å²è®°å½• (æœ€è¿‘7å¤©)</h2>
        <table id="history-table">
            <thead>
                <tr>
                    <th>æ—¥æœŸ</th>
                    <th>å¡è·¯é‡Œ</th>
                    <th>è›‹ç™½è´¨</th>
                    <th>è„‚è‚ª</th>
                    <th>ç¢³æ°´</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="history-body"></tbody>
        </table>
    </div>

    <script>
        // æ•°æ®ç»“æ„
        let nutritionData = {
            goals: {
                calories: 2000,
                protein: 150,
                fat: 65,
                carbs: 250
            },
            consumed: {
                calories: 0,
                protein: 0,
                fat: 0,
                carbs: 0
            },
            lastReset: new Date().setHours(0, 0, 0, 0),
            history: [],
            tags: []
        };

        // åŠ è½½æ•°æ®
        function loadData() {
            const savedData = localStorage.getItem('nutritionData');
            if (savedData) {
                nutritionData = JSON.parse(savedData);
                
                // ç¡®ä¿æ‰€æœ‰å±æ€§éƒ½å­˜åœ¨
                if (!nutritionData.goals) {
                    nutritionData.goals = { calories: 2000, protein: 150, fat: 65, carbs: 250 };
                }
                if (!nutritionData.consumed) {
                    nutritionData.consumed = { calories: 0, protein: 0, fat: 0, carbs: 0 };
                }
                if (!nutritionData.history) {
                    nutritionData.history = [];
                }
                if (!nutritionData.lastReset) {
                    nutritionData.lastReset = new Date().setHours(0, 0, 0, 0);
                }
                if (!nutritionData.tags) {
                    nutritionData.tags = [];
                }

                // æ£€æŸ¥æ˜¯å¦éœ€è¦é‡ç½®
                const today = new Date().setHours(0, 0, 0, 0);
                if (nutritionData.lastReset < today) {
                    saveHistory();
                    resetConsumed();
                    nutritionData.lastReset = today;
                }
            }
            saveData();
            updateDisplay();
            renderTags();
        }

        // ä¿å­˜æ•°æ®
        function saveData() {
            localStorage.setItem('nutritionData', JSON.stringify(nutritionData));
        }

        // æ›´æ–°æ˜¾ç¤º
        function updateDisplay() {
            // æ›´æ–°å‰©ä½™ç›®æ ‡
            document.getElementById('remaining-calories').textContent = 
                Math.max(0, nutritionData.goals.calories - nutritionData.consumed.calories);
            document.getElementById('remaining-protein').textContent = 
                Math.max(0, nutritionData.goals.protein - nutritionData.consumed.protein).toFixed(1);
            document.getElementById('remaining-fat').textContent = 
                Math.max(0, nutritionData.goals.fat - nutritionData.consumed.fat).toFixed(1);
            document.getElementById('remaining-carbs').textContent = 
                Math.max(0, nutritionData.goals.carbs - nutritionData.consumed.carbs).toFixed(1);

            // æ›´æ–°ç›®æ ‡è¡¨å•
            document.getElementById('goal-calories').value = nutritionData.goals.calories;
            document.getElementById('goal-protein').value = nutritionData.goals.protein;
            document.getElementById('goal-fat').value = nutritionData.goals.fat;
            document.getElementById('goal-carbs').value = nutritionData.goals.carbs;

            // æ›´æ–°å†å²è®°å½•
            updateHistory();
            
            // æ›´æ–°æ ‡ç­¾æ˜¾ç¤º
            renderTags();
        }

        // æ·»åŠ é£Ÿç‰©
        document.getElementById('add-food-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const calories = parseFloat(document.getElementById('food-calories').value);
            const protein = parseFloat(document.getElementById('food-protein').value);
            const fat = parseFloat(document.getElementById('food-fat').value);
            const carbs = parseFloat(document.getElementById('food-carbs').value);
            
            addFoodEntry(calories, protein, fat, carbs);
            
            // æ¸…ç©ºè¡¨å•
            document.getElementById('add-food-form').reset();
        });
        
        // æ·»åŠ é£Ÿç‰©æ¡ç›®
        function addFoodEntry(calories, protein, fat, carbs) {
            const now = new Date();
            const today = new Date().setHours(0, 0, 0, 0);
            
            // æ£€æŸ¥æ˜¯å¦éœ€è¦é‡ç½®ï¼ˆæ–°çš„ä¸€å¤©ï¼‰
            if (nutritionData.lastReset < today) {
                saveHistory();
                resetConsumed();
                nutritionData.lastReset = today;
                saveData();
                updateDisplay();
            }
            
            const timeString = now.getHours().toString().padStart(2, '0') + ':' + 
                             now.getMinutes().toString().padStart(2, '0');
            
            // åœ¨ä»Šæ—¥å†å²ä¸­æ·»åŠ æˆ–åˆ›å»ºæ–°è®°å½•
            let todayEntry = nutritionData.history.find(entry => new Date(entry.date).setHours(0, 0, 0, 0) === today);
            
            if (!todayEntry) {
                // å¦‚æœä»Šå¤©æ²¡æœ‰è®°å½•ï¼Œåˆ›å»ºä¸€ä¸ª
                todayEntry = {
                    date: new Date().toLocaleDateString(),
                    entries: [],
                    calories: 0,
                    protein: 0,
                    fat: 0,
                    carbs: 0
                };
                nutritionData.history.unshift(todayEntry);
            }
            
            // æ·»åŠ æ–°æ¡ç›®
            const newEntry = {
                id: Date.now(),
                time: timeString,
                calories: calories,
                protein: protein,
                fat: fat,
                carbs: carbs
            };
            
            todayEntry.entries.push(newEntry);
            
            // æ›´æ–°æ€»è®¡
            todayEntry.calories += calories;
            todayEntry.protein += protein;
            todayEntry.fat += fat;
            todayEntry.carbs += carbs;
            
            // æ›´æ–°å·²æ¶ˆè€—
            nutritionData.consumed.calories += calories;
            nutritionData.consumed.protein += protein;
            nutritionData.consumed.fat += fat;
            nutritionData.consumed.carbs += carbs;
            
            saveData();
            updateDisplay();
        }

        // è®¾ç½®ç›®æ ‡
        document.getElementById('set-goals-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            nutritionData.goals.calories = parseFloat(document.getElementById('goal-calories').value);
            nutritionData.goals.protein = parseFloat(document.getElementById('goal-protein').value);
            nutritionData.goals.fat = parseFloat(document.getElementById('goal-fat').value);
            nutritionData.goals.carbs = parseFloat(document.getElementById('goal-carbs').value);
            
            saveData();
            updateDisplay();
        });

        // æ ‡ç­¾é¡µåˆ‡æ¢
        const tabs = document.querySelectorAll('.tab');
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.getAttribute('data-tab');
                
                // æ›´æ–°æ´»åŠ¨æ ‡ç­¾
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // æ›´æ–°æ´»åŠ¨å†…å®¹
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(tabId).classList.add('active');
            });
        });

        // ä¿å­˜å†å²è®°å½•
        function saveHistory() {
            const today = new Date();
            const dateString = today.toLocaleDateString();
            
            // å¦‚æœä»Šå¤©å·²æœ‰è®°å½•ï¼Œåˆ™ä¸éœ€è¦å†æ¬¡ä¿å­˜
            if (nutritionData.history.length > 0 && 
                new Date(nutritionData.history[0].date).setHours(0, 0, 0, 0) === today.setHours(0, 0, 0, 0)) {
                return;
            }
            
            // åˆ›å»ºæ–°çš„å†å²è®°å½•
            const newEntry = {
                date: dateString,
                entries: [],
                calories: nutritionData.consumed.calories,
                protein: nutritionData.consumed.protein,
                fat: nutritionData.consumed.fat,
                carbs: nutritionData.consumed.carbs
            };
            
            // æ·»åŠ åˆ°å†å²è®°å½•
            nutritionData.history.unshift(newEntry);
            
            // åªä¿ç•™æœ€è¿‘7å¤©
            if (nutritionData.history.length > 7) {
                nutritionData.history = nutritionData.history.slice(0, 7);
            }
        }

        // é‡ç½®æ¶ˆè€—é‡
        function resetConsumed() {
            nutritionData.consumed = {
                calories: 0,
                protein: 0,
                fat: 0,
                carbs: 0
            };
        }

        // æ›´æ–°å†å²è®°å½•æ˜¾ç¤º
        function updateHistory() {
            const tbody = document.getElementById('history-body');
            tbody.innerHTML = '';
            
            nutritionData.history.forEach((day, index) => {
                const row = document.createElement('tr');
                
                const dateCell = document.createElement('td');
                dateCell.textContent = day.date;
                row.appendChild(dateCell);
                
                const caloriesCell = document.createElement('td');
                caloriesCell.textContent = day.calories;
                row.appendChild(caloriesCell);
                
                const proteinCell = document.createElement('td');
                proteinCell.textContent = day.protein.toFixed(1) + ' g';
                row.appendChild(proteinCell);
                
                const fatCell = document.createElement('td');
                fatCell.textContent = day.fat.toFixed(1) + ' g';
                row.appendChild(fatCell);
                
                const carbsCell = document.createElement('td');
                carbsCell.textContent = day.carbs.toFixed(1) + ' g';
                row.appendChild(carbsCell);
                
                // æ·»åŠ æŸ¥çœ‹è¯¦æƒ…/ç¼–è¾‘æŒ‰é’®
                const actionCell = document.createElement('td');
                const detailsBtn = document.createElement('button');
                detailsBtn.textContent = 'è¯¦æƒ…/ç¼–è¾‘';
                detailsBtn.className = 'edit-btn';
                detailsBtn.addEventListener('click', () => {
                    openDayDetailsModal(index);
                });
                actionCell.appendChild(detailsBtn);
                row.appendChild(actionCell);
                
                tbody.appendChild(row);
            });
        }
        
        // æ‰“å¼€æ—¥æœŸè¯¦æƒ…æ¨¡æ€æ¡†
        function openDayDetailsModal(dayIndex) {
            const day = nutritionData.history[dayIndex];
            
            // åˆ›å»ºæ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'day-details-modal';
            
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';
            
            // åˆ›å»ºè¡¨æ ¼æ˜¾ç¤ºå½“å¤©æ‰€æœ‰æ¡ç›®
            let entriesHTML = '';
            if (day.entries && day.entries.length > 0) {
                entriesHTML = `
                    <h3>å½“æ—¥æ¡ç›®</h3>
                    <table style="width: 100%; margin-bottom: 20px;">
                        <thead>
                            <tr>
                                <th>æ—¶é—´</th>
                                <th>å¡è·¯é‡Œ</th>
                                <th>è›‹ç™½è´¨</th>
                                <th>è„‚è‚ª</th>
                                <th>ç¢³æ°´</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                day.entries.forEach((entry, index) => {
                    entriesHTML += `
                        <tr>
                            <td>${entry.time || '--'}</td>
                            <td>${entry.calories}</td>
                            <td>${entry.protein.toFixed(1)} g</td>
                            <td>${entry.fat.toFixed(1)} g</td>
                            <td>${entry.carbs.toFixed(1)} g</td>
                            <td>
                                <button class="edit-btn" data-entry-index="${index}">ç¼–è¾‘</button>
                                <button class="delete-btn" data-entry-index="${index}">åˆ é™¤</button>
                            </td>
                        </tr>
                    `;
                });
                
                entriesHTML += `
                        </tbody>
                    </table>
                `;
            } else {
                entriesHTML = '<p>å½“æ—¥æ²¡æœ‰è¯¦ç»†è®°å½•ã€‚</p>';
            }
            
            modalContent.innerHTML = `
                <h2>${day.date} è¯¦æƒ…</h2>
                ${entriesHTML}
                <h3>æ—¥æ€»è®¡</h3>
                <form id="day-total-form">
                    <div class="form-group">
                        <label for="day-calories">å¡è·¯é‡Œ</label>
                        <input type="number" id="day-calories" value="${day.calories}" min="0" step="1" required>
                    </div>
                    <div class="form-group">
                        <label for="day-protein">è›‹ç™½è´¨ (g)</label>
                        <input type="number" id="day-protein" value="${day.protein}" min="0" step="0.1" required>
                    </div>
                    <div class="form-group">
                        <label for="day-fat">è„‚è‚ª (g)</label>
                        <input type="number" id="day-fat" value="${day.fat}" min="0" step="0.1" required>
                    </div>
                    <div class="form-group">
                        <label for="day-carbs">ç¢³æ°´ (g)</label>
                        <input type="number" id="day-carbs" value="${day.carbs}" min="0" step="0.1" required>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                        <button type="button" id="cancel-day-edit">å…³é—­</button>
                        <button type="submit">ä¿å­˜ä¿®æ”¹</button>
                    </div>
                </form>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            modal.style.display = 'block';
            
            // å…³é—­æŒ‰é’®äº‹ä»¶
            document.getElementById('cancel-day-edit').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            
            // ç¼–è¾‘æ¡ç›®æŒ‰é’®äº‹ä»¶
            const editButtons = modal.querySelectorAll('.edit-btn[data-entry-index]');
            editButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const entryIndex = parseInt(button.getAttribute('data-entry-index'));
                    openEntryEditModal(dayIndex, entryIndex);
                });
            });
            
            // åˆ é™¤æ¡ç›®æŒ‰é’®äº‹ä»¶
            const deleteButtons = modal.querySelectorAll('.delete-btn[data-entry-index]');
            deleteButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const entryIndex = parseInt(button.getAttribute('data-entry-index'));
                    deleteEntry(dayIndex, entryIndex);
                    document.body.removeChild(modal);
                });
            });
            
            // è¡¨å•æäº¤äº‹ä»¶
            document.getElementById('day-total-form').addEventListener('submit', (e) => {
                e.preventDefault();
                
                // è·å–ä¿®æ”¹åçš„å€¼
                const calories = parseFloat(document.getElementById('day-calories').value);
                const protein = parseFloat(document.getElementById('day-protein').value);
                const fat = parseFloat(document.getElementById('day-fat').value);
                const carbs = parseFloat(document.getElementById('day-carbs').value);
                
                const isToday = new Date(day.date).setHours(0, 0, 0, 0) === new Date().setHours(0, 0, 0, 0);
                
                // æ›´æ–°å†å²æ•°æ®
                nutritionData.history[dayIndex].calories = calories;
                nutritionData.history[dayIndex].protein = protein;
                nutritionData.history[dayIndex].fat = fat;
                nutritionData.history[dayIndex].carbs = carbs;
                
                // å¦‚æœæ˜¯ä»Šå¤©ï¼ŒåŒæ—¶æ›´æ–°å½“å‰æ¶ˆè€—é‡
                if (isToday) {
                    nutritionData.consumed.calories = calories;
                    nutritionData.consumed.protein = protein;
                    nutritionData.consumed.fat = fat;
                    nutritionData.consumed.carbs = carbs;
                }
                
                saveData();
                updateDisplay();
                
                // å…³é—­æ¨¡æ€æ¡†
                document.body.removeChild(modal);
            });
        }
        
        // æ‰“å¼€æ¡ç›®ç¼–è¾‘æ¨¡æ€æ¡†
        function openEntryEditModal(dayIndex, entryIndex) {
            const entry = nutritionData.history[dayIndex].entries[entryIndex];
            
            // åˆ›å»ºæ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'entry-edit-modal';
            
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';
            
            modalContent.innerHTML = `
                <h2>ç¼–è¾‘æ¡ç›®</h2>
                <form id="entry-edit-form">
                    <div class="form-group">
                        <label for="entry-calories">å¡è·¯é‡Œ</label>
                        <input type="number" id="entry-calories" value="${entry.calories}" min="0" step="1" required>
                    </div>
                    <div class="form-group">
                        <label for="entry-protein">è›‹ç™½è´¨ (g)</label>
                        <input type="number" id="entry-protein" value="${entry.protein}" min="0" step="0.1" required>
                    </div>
                    <div class="form-group">
                        <label for="entry-fat">è„‚è‚ª (g)</label>
                        <input type="number" id="entry-fat" value="${entry.fat}" min="0" step="0.1" required>
                    </div>
                    <div class="form-group">
                        <label for="entry-carbs">ç¢³æ°´ (g)</label>
                        <input type="number" id="entry-carbs" value="${entry.carbs}" min="0" step="0.1" required>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                        <button type="button" id="cancel-entry-edit">å–æ¶ˆ</button>
                        <button type="submit">ä¿å­˜</button>
                    </div>
                </form>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            modal.style.display = 'block';
            
            // å–æ¶ˆæŒ‰é’®äº‹ä»¶
            document.getElementById('cancel-entry-edit').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            
            // è¡¨å•æäº¤äº‹ä»¶
            document.getElementById('entry-edit-form').addEventListener('submit', (e) => {
                e.preventDefault();
                
                // è·å–åŸå§‹å€¼ï¼ˆç”¨äºè®¡ç®—å·®å€¼ï¼‰
                const oldCalories = entry.calories;
                const oldProtein = entry.protein;
                const oldFat = entry.fat;
                const oldCarbs = entry.carbs;
                
                // è·å–æ–°å€¼
                const newCalories = parseFloat(document.getElementById('entry-calories').value);
                const newProtein = parseFloat(document.getElementById('entry-protein').value);
                const newFat = parseFloat(document.getElementById('entry-fat').value);
                const newCarbs = parseFloat(document.getElementById('entry-carbs').value);
                
                // è®¡ç®—å·®å€¼
                const diffCalories = newCalories - oldCalories;
                const diffProtein = newProtein - oldProtein;
                const diffFat = newFat - oldFat;
                const diffCarbs = newCarbs - oldCarbs;
                
                // æ›´æ–°æ¡ç›®
                entry.calories = newCalories;
                entry.protein = newProtein;
                entry.fat = newFat;
                entry.carbs = newCarbs;
                
                // æ›´æ–°æ—¥æ€»è®¡
                nutritionData.history[dayIndex].calories += diffCalories;
                nutritionData.history[dayIndex].protein += diffProtein;
                nutritionData.history[dayIndex].fat += diffFat;
                nutritionData.history[dayIndex].carbs += diffCarbs;
                
                // å¦‚æœæ˜¯ä»Šå¤©ï¼ŒåŒæ—¶æ›´æ–°å½“å‰æ¶ˆè€—é‡
                const isToday = new Date(nutritionData.history[dayIndex].date).setHours(0, 0, 0, 0) === new Date().setHours(0, 0, 0, 0);
                if (isToday) {
                    nutritionData.consumed.calories += diffCalories;
                    nutritionData.consumed.protein += diffProtein;
                    nutritionData.consumed.fat += diffFat;
                    nutritionData.consumed.carbs += diffCarbs;
                }
                
                saveData();
                updateDisplay();
                
                // å…³é—­å½“å‰æ¨¡æ€æ¡†
                document.body.removeChild(modal);
                
                // é‡æ–°æ‰“å¼€æ—¥æœŸè¯¦æƒ…æ¨¡æ€æ¡†ï¼Œæ˜¾ç¤ºæ›´æ–°åçš„å†…å®¹
                openDayDetailsModal(dayIndex);
            });
        }
        
    // åˆ é™¤æ¡ç›®
function deleteEntry(dayIndex, entryIndex) {
    const entry = nutritionData.history[dayIndex].entries[entryIndex];
    const day = nutritionData.history[dayIndex];
    
    // ä»æ€»è®¡ä¸­å‡å»æ¡ç›®å€¼
    day.calories = Math.max(0, day.calories - entry.calories);
    day.protein = Math.max(0, day.protein - entry.protein);
    day.fat = Math.max(0, day.fat - entry.fat);
    day.carbs = Math.max(0, day.carbs - entry.carbs);
    
    // å¦‚æœæ˜¯ä»Šå¤©ï¼ŒåŒæ—¶æ›´æ–°å½“å‰æ¶ˆè€—é‡
    const isToday = new Date(day.date).setHours(0, 0, 0, 0) === new Date().setHours(0, 0, 0, 0);
    if (isToday) {
        nutritionData.consumed.calories = Math.max(0, nutritionData.consumed.calories - entry.calories);
        nutritionData.consumed.protein = Math.max(0, nutritionData.consumed.protein - entry.protein);
        nutritionData.consumed.fat = Math.max(0, nutritionData.consumed.fat - entry.fat);
        nutritionData.consumed.carbs = Math.max(0, nutritionData.consumed.carbs - entry.carbs);
    }
    
    // åˆ é™¤æ¡ç›®
    day.entries.splice(entryIndex, 1);
    
    saveData();
    updateDisplay();
}

        // æ ‡ç­¾ç®¡ç†åŠŸèƒ½
        document.getElementById('tag-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const name = document.getElementById('tag-name').value;
            const calories = parseFloat(document.getElementById('tag-calories').value);
            const protein = parseFloat(document.getElementById('tag-protein').value);
            const fat = parseFloat(document.getElementById('tag-fat').value);
            const carbs = parseFloat(document.getElementById('tag-carbs').value);
            
            // æ·»åŠ æ ‡ç­¾
            const tag = {
                id: Date.now(),
                name: name,
                calories: calories,
                protein: protein,
                fat: fat,
                carbs: carbs,
                visible: true
            };
            
            nutritionData.tags.push(tag);
            saveData();
            renderTags();
            
            // æ¸…ç©ºè¡¨å•
            document.getElementById('tag-form').reset();
        });
        
        // æ¸²æŸ“æ ‡ç­¾
        function renderTags() {
            const tagsContainer = document.getElementById('tags-container');
            const quickTagsContainer = document.getElementById('quick-tags-container');
            
            tagsContainer.innerHTML = '';
            quickTagsContainer.innerHTML = '';
            
            nutritionData.tags.forEach(tag => {
                // åœ¨æ ‡ç­¾ç®¡ç†é¡µé¢æ¸²æŸ“
                const tagElement = document.createElement('div');
                tagElement.className = 'tag-item' + (tag.visible ? '' : ' hidden');
                tagElement.innerHTML = `
                    <span>${tag.name} (${tag.calories}å¡, ${tag.protein}è›‹ç™½, ${tag.fat}è„‚è‚ª, ${tag.carbs}ç¢³æ°´)</span>
                    <span class="tag-visibility" title="${tag.visible ? 'éšè—æ ‡ç­¾' : 'æ˜¾ç¤ºæ ‡ç­¾'}">
                        ${tag.visible ? 'ğŸ‘ï¸' : 'ğŸ‘ï¸â€ğŸ—¨ï¸'}
                    </span>
                    <span class="tag-delete" title="åˆ é™¤æ ‡ç­¾">âŒ</span>
                `;
                
                // åˆ é™¤æ ‡ç­¾
                tagElement.querySelector('.tag-delete').addEventListener('click', (e) => {
                    e.stopPropagation();
                    const tagIndex = nutritionData.tags.findIndex(t => t.id === tag.id);
                    if (tagIndex !== -1) {
                        nutritionData.tags.splice(tagIndex, 1);
                        saveData();
                        renderTags();
                    }
                });
                
                // åˆ‡æ¢å¯è§æ€§
                tagElement.querySelector('.tag-visibility').addEventListener('click', (e) => {
                    e.stopPropagation();
                    const tagIndex = nutritionData.tags.findIndex(t => t.id === tag.id);
                    if (tagIndex !== -1) {
                        nutritionData.tags[tagIndex].visible = !nutritionData.tags[tagIndex].visible;
                        saveData();
                        renderTags();
                    }
                });
                
                tagsContainer.appendChild(tagElement);
                
                // åœ¨å¿«é€Ÿæ·»åŠ åŒºåŸŸæ¸²æŸ“å¯è§æ ‡ç­¾
                if (tag.visible) {
                    const quickTagElement = document.createElement('div');
                    quickTagElement.className = 'tag-item';
                    quickTagElement.textContent = tag.name;
                    
                    // ç‚¹å‡»å¿«é€Ÿæ·»åŠ 
                    quickTagElement.addEventListener('click', () => {
                        addFoodEntry(tag.calories, tag.protein, tag.fat, tag.carbs);
                    });
                    
                    quickTagsContainer.appendChild(quickTagElement);
                }
            });
        }

        // åˆå§‹åŒ–
        loadData();
    </script>
</body>
</html>